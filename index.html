<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠŸæ•ˆæœå°‹ç³»çµ± - é£Ÿç‰©ã€è—¥ç‰©ã€ä¿å¥é£Ÿå“</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --accent: #14b8a6;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --gray: #64748b;
            --light: #f1f5f9;
            --white: #ffffff;
            --gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
            --gradient-soft: linear-gradient(135deg, #f0f9ff 0%, #fdf4ff 100%);
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--gradient);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
        }

        header {
            background: var(--gradient);
            color: var(--white);
            padding: 40px;
            text-align: center;
            position: relative;
        }

        header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .api-key-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .api-key-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        main {
            padding: 30px;
        }

        .input-section {
            margin-bottom: 25px;
        }

        .input-section label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1em;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .image-upload-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
        }

        .image-upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload-area:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .image-upload-input {
            display: none;
        }

        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .image-preview-item {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .image-preview-item .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
        }

        .search-btn {
            width: 100%;
            padding: 16px;
            background: var(--gradient);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .search-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
        }

        .search-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .result-section {
            margin-top: 25px;
            padding: 25px;
            background: var(--gradient-soft);
            border-radius: 16px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .result-header h2 {
            font-size: 1.4em;
            color: var(--dark);
        }

        .food-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .food-tag {
            background: var(--gradient);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .item-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .item-tab {
            padding: 10px 20px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .item-tab:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .item-tab.active {
            background: var(--gradient);
            color: white;
            border-color: var(--primary);
        }

        .result-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            line-height: 1.8;
        }

        .result-content h2 {
            color: var(--primary-dark);
            font-size: 1.3em;
            margin: 25px 0 15px;
            padding: 12px 16px;
            background: linear-gradient(135deg, #f0f9ff 0%, #ede9fe 100%);
            border-left: 4px solid var(--primary);
            border-radius: 0 8px 8px 0;
        }

        .result-content h2:first-child {
            margin-top: 0;
        }

        .result-content h3 {
            color: var(--secondary);
            font-size: 1.15em;
            margin: 20px 0 12px;
            padding-bottom: 8px;
            border-bottom: 2px dashed rgba(236, 72, 153, 0.3);
        }

        .result-content h4 {
            color: var(--accent);
            font-size: 1.05em;
            margin: 15px 0 10px;
        }

        .result-content ul {
            list-style: none;
            padding: 0;
            margin: 12px 0;
        }

        .result-content li {
            padding: 10px 15px 10px 35px;
            margin-bottom: 8px;
            background: rgba(99, 102, 241, 0.05);
            border-radius: 8px;
            position: relative;
            border-left: 3px solid var(--primary);
        }

        .result-content li::before {
            content: 'â€¢';
            position: absolute;
            left: 15px;
            color: var(--primary);
        }

        .result-content strong {
            color: var(--primary);
        }

        .result-content p {
            margin-bottom: 12px;
        }

        .interaction-section {
            margin-top: 25px;
            padding: 25px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 16px;
            border-left: 5px solid var(--warning);
        }

        .save-warning-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .save-warning-btn:hover {
            transform: translateY(-2px);
        }

        .error-message {
            background: #fef2f2;
            color: var(--danger);
            padding: 15px 20px;
            border-radius: 12px;
            border-left: 4px solid var(--danger);
            margin-top: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 450px;
            width: 90%;
        }

        .modal-content h3 {
            margin-bottom: 20px;
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: var(--dark);
        }

        footer {
            text-align: center;
            padding: 20px;
            color: var(--gray);
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            header h1 { font-size: 1.8em; }
            main { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="api-key-btn" id="openApiKeyModal">âš™ï¸ API è¨­å®š</button>
            <h1>ğŸ”¬ åŠŸæ•ˆæœå°‹ç³»çµ±</h1>
            <p class="subtitle">æ™ºèƒ½åˆ†æé£Ÿç‰©ã€è—¥ç‰©ã€ä¿å¥é£Ÿå“çš„åŠŸæ•ˆèˆ‡äº¤äº’ä½œç”¨</p>
        </header>

        <main>
            <div class="input-section">
                <label>ğŸ·ï¸ è¼¸å…¥åç¨±ï¼ˆå¯è¼¸å…¥å¤šç¨®ï¼Œç”¨é€—è™Ÿæˆ–æ›è¡Œåˆ†éš”ï¼‰</label>
                <textarea id="foodInput" placeholder="ä¾‹å¦‚ï¼šé¦™è•‰ã€ç‰›å¥¶ã€ç¶­ä»–å‘½C"></textarea>
            </div>

            <div class="image-upload-section">
                <label>ğŸ“· ä¸Šå‚³åœ–ç‰‡è¾¨è­˜ï¼ˆå¯ä¸Šå‚³å¤šå¼µï¼‰</label>
                <div class="image-upload-area" id="imageUploadArea">
                    <div>ğŸ“¸</div>
                    <div>é»æ“Šæˆ–æ‹–æ”¾åœ–ç‰‡åˆ°æ­¤è™•</div>
                    <div style="font-size: 0.85em; color: #94a3b8;">æ”¯æ´ JPGã€PNGã€WEBP æ ¼å¼</div>
                    <input type="file" id="imageInput" class="image-upload-input" accept="image/*" multiple>
                </div>
                <div class="image-preview-container" id="imagePreviewContainer"></div>
            </div>

            <button id="searchBtn" class="search-btn">
                <span class="btn-text">ğŸ” æœå°‹åŠŸæ•ˆ</span>
                <span class="btn-loading" style="display: none;">æœå°‹ä¸­...</span>
            </button>

            <div id="resultSection" class="result-section" style="display: none;">
                <div class="result-header">
                    <div>
                        <h2>âœ¨ æœå°‹çµæœ</h2>
                        <div id="foodTags" class="food-tags"></div>
                    </div>
                    <button id="saveWarningBtn" class="save-warning-btn" style="display: none;">
                        âš ï¸ å„²å­˜ç¦å¿Œæé†’
                    </button>
                </div>
                <div id="itemTabs" class="item-tabs" style="display: none;"></div>
                <div id="resultContent" class="result-content"></div>
                <div id="interactionSection" class="interaction-section" style="display: none;"></div>
            </div>

            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </main>

        <footer>
            âš¡ Powered by Google Gemini 2.0 Flash
        </footer>
    </div>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="modal">
        <div class="modal-content">
            <h3>ğŸ”‘ è¨­å®š Gemini API Key</h3>
            <input type="password" id="apiKeyInput" placeholder="è«‹è¼¸å…¥æ‚¨çš„ API Key">
            <div class="modal-buttons">
                <button class="btn-secondary" id="cancelBtn">å–æ¶ˆ</button>
                <button class="btn-primary" id="saveApiKeyBtn">å„²å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // ===== å…¨åŸŸè®Šæ•¸ =====
        let uploadedImages = [];
        let db = null;

        // ===== DOM å…ƒç´  =====
        const foodInput = document.getElementById('foodInput');
        const searchBtn = document.getElementById('searchBtn');
        const resultSection = document.getElementById('resultSection');
        const resultContent = document.getElementById('resultContent');
        const foodTags = document.getElementById('foodTags');
        const itemTabs = document.getElementById('itemTabs');
        const interactionSection = document.getElementById('interactionSection');
        const errorMessage = document.getElementById('errorMessage');
        const saveWarningBtn = document.getElementById('saveWarningBtn');
        const apiKeyModal = document.getElementById('apiKeyModal');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const imageInput = document.getElementById('imageInput');
        const imageUploadArea = document.getElementById('imageUploadArea');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');

        // ===== IndexedDB åˆå§‹åŒ– =====
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('FoodEfficacyDB', 1);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains('warnings')) {
                        database.createObjectStore('warnings', { keyPath: 'id', autoIncrement: true });
                    }
                };
            });
        }

        // ===== API Key Modal =====
        document.getElementById('openApiKeyModal').addEventListener('click', () => {
            apiKeyInput.value = localStorage.getItem('gemini_api_key') || '';
            apiKeyModal.classList.add('show');
        });

        document.getElementById('cancelBtn').addEventListener('click', () => {
            apiKeyModal.classList.remove('show');
        });

        document.getElementById('saveApiKeyBtn').addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                apiKeyModal.classList.remove('show');
            }
        });

        apiKeyModal.addEventListener('click', (e) => {
            if (e.target === apiKeyModal) apiKeyModal.classList.remove('show');
        });

        // ===== åœ–ç‰‡ä¸Šå‚³ =====
        imageUploadArea.addEventListener('click', () => imageInput.click());
        
        imageInput.addEventListener('change', (e) => handleImageUpload(e.target.files));

        imageUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageUploadArea.style.borderColor = 'var(--primary)';
        });

        imageUploadArea.addEventListener('dragleave', () => {
            imageUploadArea.style.borderColor = '#cbd5e1';
        });

        imageUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            imageUploadArea.style.borderColor = '#cbd5e1';
            handleImageUpload(e.dataTransfer.files);
        });

        function handleImageUpload(files) {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadedImages.push({
                            dataUrl: e.target.result,
                            base64: e.target.result.split(',')[1],
                            mimeType: file.type
                        });
                        updateImagePreview();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function updateImagePreview() {
            imagePreviewContainer.innerHTML = uploadedImages.map((img, i) => `
                <div class="image-preview-item">
                    <img src="${img.dataUrl}" alt="é è¦½">
                    <button class="remove-btn" onclick="removeImage(${i})">Ã—</button>
                </div>
            `).join('');
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            updateImagePreview();
        }

        // ===== æœå°‹åŠŸèƒ½ =====
        searchBtn.addEventListener('click', handleSearch);

        async function handleSearch() {
            const input = foodInput.value.trim();
            const apiKey = localStorage.getItem('gemini_api_key');

            if (!apiKey) {
                showError('è«‹å…ˆè¨­å®š Gemini API Key');
                apiKeyModal.classList.add('show');
                return;
            }

            if (!input && uploadedImages.length === 0) {
                showError('è«‹è¼¸å…¥é …ç›®åç¨±æˆ–ä¸Šå‚³åœ–ç‰‡');
                return;
            }

            // è§£æè¼¸å…¥çš„é …ç›®
            const foods = input ? input.split(/[,\nï¼Œã€\s]+/).map(f => f.trim()).filter(f => f) : [];

            setLoading(true);
            hideError();
            hideResult();

            try {
                // æ§‹å»ºæç¤ºè©
                const prompt = buildPrompt(foods, uploadedImages.length > 0);

                // API è«‹æ±‚
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const parts = [{ text: prompt }];
                uploadedImages.forEach(img => {
                    parts.push({
                        inlineData: {
                            data: img.base64,
                            mimeType: img.mimeType
                        }
                    });
                });

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 8192
                        }
                    })
                });

                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.error?.message || `API éŒ¯èª¤: ${response.status}`);
                }

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.map(p => p.text).join('') || '';

                if (!text) throw new Error('ç„¡æ³•å–å¾—å›æ‡‰å…§å®¹');

                // é¡¯ç¤ºçµæœ
                displayResult(foods, text);
                saveCache(foods, text);

            } catch (error) {
                console.error('æœå°‹éŒ¯èª¤:', error);
                showError(error.message || 'æœå°‹æ™‚ç™¼ç”ŸéŒ¯èª¤');
            } finally {
                setLoading(false);
            }
        }

        function buildPrompt(foods, hasImages) {
            const itemList = foods.join('ã€');
            
            let prompt = '';
            
            if (hasImages) {
                prompt = `è«‹è¾¨è­˜åœ–ç‰‡ä¸­çš„é£Ÿç‰©ã€è—¥ç‰©æˆ–ä¿å¥é£Ÿå“ï¼Œä¸¦åˆ†æå…¶åŠŸæ•ˆã€‚
${itemList ? `åŒæ™‚ä¹Ÿåˆ†æé€™äº›é …ç›®ï¼š${itemList}` : ''}

è¾¨è­˜è¦æ±‚ï¼š
- åªè¾¨è­˜ç¢ºå®šèƒ½çœ‹åˆ°çš„ç‰©å“
- ç„¡æ³•è¾¨è­˜è«‹èªªæ˜ã€Œç„¡æ³•è¾¨è­˜ã€
- ä¸è¦ç·¨é€ ä¸å­˜åœ¨çš„ç‰©å“
`;
            } else {
                prompt = `è«‹åˆ†æä»¥ä¸‹é …ç›®çš„åŠŸæ•ˆï¼š${itemList}
`;
            }

            prompt += `
è«‹ä»¥ç¹é«”ä¸­æ–‡å›ç­”ï¼Œä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š

${foods.map(food => `
## ${food}

### åŸºæœ¬è³‡è¨Š
- **é¡å‹ï¼š** (é£Ÿç‰©/è—¥ç‰©/ä¿å¥é£Ÿå“)
- **ä¸»è¦æˆåˆ†ï¼š** (åˆ—å‡ºä¸»è¦æˆåˆ†)

### åŠŸæ•ˆèˆ‡ç›Šè™•
- (åŠŸæ•ˆ1)
- (åŠŸæ•ˆ2)
- (åŠŸæ•ˆ3)

### æ³¨æ„äº‹é …
- **é©ç”¨äººç¾¤ï¼š** (èªªæ˜)
- **ç¦å¿Œäººç¾¤ï¼š** (èªªæ˜)
- **å»ºè­°ç”¨é‡ï¼š** (èªªæ˜)
`).join('\n')}

${foods.length > 1 ? `
## ğŸ”— äº¤äº’ä½œç”¨åˆ†æ

### âœ… æ­£é¢æ•ˆæœ
(åˆ—å‡ºé€™äº›é …ç›®ä¸€èµ·ä½¿ç”¨çš„æ­£é¢æ•ˆæœï¼Œå¦‚å”åŒä½œç”¨ã€å¢å¼·å¸æ”¶ç­‰)

### âš ï¸ è² é¢æ•ˆæœèˆ‡é¢¨éšª
è«‹è©³ç´°èªªæ˜ï¼š
- æ˜¯å¦æœ‰è² é¢äº¤äº’ä½œç”¨ï¼Ÿ
- æ˜¯ã€Œçµ•å°ç¦å¿Œã€é‚„æ˜¯ã€Œæ½›åœ¨é¢¨éšªã€ï¼Ÿ
- ä½œç”¨æ©Ÿç†æ˜¯ä»€éº¼ï¼Ÿï¼ˆå¦‚ï¼šå–®å¯§é…¸èˆ‡è›‹ç™½è³ªçµåˆå½¢æˆèƒƒæŸ¿çŸ³ã€äºç¡é…¸é¹½èˆ‡èƒºé¡å½¢æˆäºç¡èƒºç­‰ï¼‰
- å¯èƒ½ç”¢ç”Ÿä»€éº¼ç—‡ç‹€ï¼Ÿ

### â° é–“éš”æ™‚é–“å»ºè­°
**å¦‚æœæœ‰äº¤äº’ä½œç”¨é¢¨éšªï¼Œè«‹æ˜ç¢ºèªªæ˜ï¼š**
- å»ºè­°é–“éš”å¤šä¹…é£Ÿç”¨ï¼Ÿï¼ˆå¦‚ï¼šé–“éš”2å°æ™‚ã€é–“éš”4å°æ™‚ç­‰ï¼‰
- ç‚ºä»€éº¼éœ€è¦é€™å€‹é–“éš”æ™‚é–“ï¼Ÿ
- å“ªå€‹æ‡‰è©²å…ˆåƒï¼Ÿ

### ğŸ’¡ é£Ÿç”¨å»ºè­°
- æ˜¯å¦éœ€è¦æ­é…å…¶ä»–é£Ÿç‰©ä¾†é™ä½é¢¨éšªï¼Ÿï¼ˆå¦‚ï¼šæ­é…å¯Œå«ç¶­ä»–å‘½Cçš„é£Ÿç‰©ï¼‰
- æœ‰ç„¡ç‰¹æ®Šè™•ç†æ–¹å¼ï¼Ÿ
- å“ªäº›äººç¾¤éœ€è¦ç‰¹åˆ¥æ³¨æ„ï¼Ÿ
` : ''}

## ğŸ“ ç¸½çµ
(æä¾›3-5æ¢å…·é«”ä½¿ç”¨å»ºè­°)
`;
            return prompt;
        }

        // ===== é¡¯ç¤ºçµæœ =====
        function displayResult(foods, text) {
            // é¡¯ç¤ºé£Ÿç‰©æ¨™ç±¤
            foodTags.innerHTML = foods.map(f => `<span class="food-tag">${f}</span>`).join('');

            // è§£æçµæœ
            const parsed = parseResult(text, foods);

            // å¦‚æœæœ‰å¤šå€‹é …ç›®ï¼Œé¡¯ç¤ºåˆ‡æ›æŒ‰éˆ•
            if (foods.length > 1 && parsed.items.length > 0) {
                itemTabs.style.display = 'flex';
                itemTabs.innerHTML = foods.map((food, i) => 
                    `<button class="item-tab ${i === 0 ? 'active' : ''}" data-index="${i}">${food}</button>`
                ).join('');

                // é¡¯ç¤ºç¬¬ä¸€å€‹é …ç›®çš„å…§å®¹
                resultContent.innerHTML = parsed.items.map((item, i) => 
                    `<div class="item-content" data-index="${i}" style="${i !== 0 ? 'display:none;' : ''}">${formatMarkdown(item.content)}</div>`
                ).join('');

                // åˆ‡æ›äº‹ä»¶
                itemTabs.querySelectorAll('.item-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const index = parseInt(tab.dataset.index);
                        itemTabs.querySelectorAll('.item-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        resultContent.querySelectorAll('.item-content').forEach(c => c.style.display = 'none');
                        const target = resultContent.querySelector(`.item-content[data-index="${index}"]`);
                        if (target) target.style.display = 'block';
                    });
                });
            } else {
                itemTabs.style.display = 'none';
                resultContent.innerHTML = formatMarkdown(text);
            }

            // é¡¯ç¤ºäº¤äº’ä½œç”¨åˆ†æ
            if (foods.length > 1 && parsed.interaction) {
                interactionSection.style.display = 'block';
                interactionSection.innerHTML = formatMarkdown(parsed.interaction);
            } else {
                interactionSection.style.display = 'none';
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰è­¦å‘Šå…§å®¹
            if (hasWarningContent(text) && foods.length > 1) {
                saveWarningBtn.style.display = 'block';
                saveWarningBtn.onclick = () => saveWarning(foods, text);
            } else {
                saveWarningBtn.style.display = 'none';
            }

            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        function parseResult(text, foods) {
            const result = { items: [], interaction: '' };

            // æå–äº¤äº’ä½œç”¨åˆ†æ
            const interactionMatch = text.match(/##\s*ğŸ”—?\s*äº¤äº’ä½œç”¨åˆ†æ[\s\S]*?(?=##\s*ğŸ“|$)/i);
            if (interactionMatch) {
                result.interaction = interactionMatch[0];
            }

            // ç‚ºæ¯å€‹é£Ÿç‰©æå–å…§å®¹
            for (let i = 0; i < foods.length; i++) {
                const food = foods[i];
                const nextFood = foods[i + 1];
                
                // å°‹æ‰¾è©²é£Ÿç‰©çš„å€å¡Š
                const startPattern = new RegExp(`##\\s*${escapeRegex(food)}[\\s\\S]*?(?=##\\s*${nextFood ? escapeRegex(nextFood) : 'ğŸ”—|ğŸ“'}|$)`, 'i');
                const match = text.match(startPattern);
                
                if (match) {
                    result.items.push({
                        name: food,
                        content: match[0]
                    });
                }
            }

            // å¦‚æœæ²’æœ‰åŒ¹é…åˆ°ä»»ä½•é …ç›®ï¼Œå˜—è©¦ç”¨ç°¡å–®åˆ†å‰²
            if (result.items.length === 0 && foods.length > 0) {
                const cleanText = text.replace(/##\s*ğŸ”—[\s\S]*$/i, '').replace(/##\s*ğŸ“[\s\S]*$/i, '');
                result.items.push({
                    name: foods[0],
                    content: cleanText
                });
            }

            return result;
        }

        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // ===== Markdown æ ¼å¼åŒ– =====
        function formatMarkdown(text) {
            if (!text) return '';
            
            let html = text;
            
            // æ¨™é¡Œ
            html = html.replace(/^#### (.*)$/gim, '<h4>$1</h4>');
            html = html.replace(/^### (.*)$/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*)$/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*)$/gim, '<h1>$1</h1>');
            
            // ç²—é«”
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // åˆ—è¡¨
            const lines = html.split('\n');
            let inList = false;
            const result = [];
            
            for (const line of lines) {
                const trimmed = line.trim();
                const listMatch = trimmed.match(/^[-*]\s+(.*)$/);
                const numMatch = trimmed.match(/^\d+\.\s+(.*)$/);
                
                if (listMatch || numMatch) {
                    if (!inList) {
                        result.push('<ul>');
                        inList = true;
                    }
                    result.push(`<li>${listMatch ? listMatch[1] : numMatch[1]}</li>`);
                } else {
                    if (inList) {
                        result.push('</ul>');
                        inList = false;
                    }
                    if (trimmed) result.push(trimmed);
                }
            }
            if (inList) result.push('</ul>');
            
            html = result.join('\n');
            
            // æ®µè½
            html = html.split('\n\n').map(p => {
                p = p.trim();
                if (!p || p.startsWith('<')) return p;
                return `<p>${p}</p>`;
            }).join('\n');
            
            return html;
        }

        // ===== å·¥å…·å‡½æ•¸ =====
        function hasWarningContent(text) {
            const keywords = ['ä¸èƒ½åŒæ™‚', 'ç¦å¿Œ', 'è­¦å‘Š', 'å±éšª', 'âš ï¸', 'ğŸš¨', 'çµ•å°ç¦å¿Œ', 'è² é¢æ•ˆæœ'];
            return keywords.some(k => text.includes(k));
        }

        async function saveWarning(foods, text) {
            if (!db) await initDB();
            
            const tx = db.transaction(['warnings'], 'readwrite');
            const store = tx.objectStore('warnings');
            
            await store.add({
                items: foods,
                content: `${foods.join('+')} - æ³¨æ„äº¤äº’ä½œç”¨`,
                result: text,
                timestamp: new Date().toISOString()
            });

            saveWarningBtn.textContent = 'âœ“ å·²å„²å­˜';
            saveWarningBtn.style.background = 'var(--success)';
            setTimeout(() => {
                saveWarningBtn.textContent = 'âš ï¸ å„²å­˜ç¦å¿Œæé†’';
                saveWarningBtn.style.background = '';
            }, 2000);
        }

        function saveCache(foods, text) {
            localStorage.setItem('efficacy_cache', JSON.stringify({ foods, text }));
        }

        function loadCache() {
            const cache = localStorage.getItem('efficacy_cache');
            if (cache) {
                try {
                    const { foods, text } = JSON.parse(cache);
                    if (foods && text) {
                        displayResult(foods, text);
                    }
                } catch (e) {}
            }
        }

        function setLoading(loading) {
            searchBtn.disabled = loading;
            searchBtn.querySelector('.btn-text').style.display = loading ? 'none' : 'inline';
            searchBtn.querySelector('.btn-loading').style.display = loading ? 'inline' : 'none';
        }

        function showError(msg) {
            errorMessage.textContent = msg;
            errorMessage.style.display = 'block';
            resultSection.style.display = 'none';
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        function hideResult() {
            resultSection.style.display = 'none';
        }

        // ===== åˆå§‹åŒ– =====
        initDB().catch(console.error);
        loadCache();
    </script>
</body>
</html>
